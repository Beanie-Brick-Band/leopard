# Convex API Route Documentation

Complete documentation of all backend Convex routes with schemas and behavior descriptions.

---

## Authentication

| Route                   | Normal Behaviour                                                     | API Input Schema    | API Output Schema                                           | Implementation                                                     | Undesired Behaviours                                    |
| ----------------------- | -------------------------------------------------------------------- | ------------------- | ----------------------------------------------------------- | ------------------------------------------------------------------ | ------------------------------------------------------- |
| **auth.getCurrentUser** | Returns the current authenticated user or null if not authenticated. | `{}` (No arguments) | `{ _id: string, email: string, name: string, ... } \| null` | Uses Better Auth component to get authenticated user from context. | None; safely returns null for unauthenticated requests. |

---

## User Profile Management

| Route                                               | Normal Behaviour                                                       | API Input Schema                                             | API Output Schema                                                                                         | Implementation                                                                 | Undesired Behaviours                                                              |
| --------------------------------------------------- | ---------------------------------------------------------------------- | ------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------ | --------------------------------------------------------------------------------- |
| **userProfile.getProfile**                          | Retrieves the authenticated user's profile including role information. | `{}` (No arguments)                                          | `{ _id: Id<"userProfiles">, userId: string, role: "student" \| "teacher", createdAt: number } \| null`    | Queries userProfiles table by userId with Better Auth authentication check.    | Returns null if user is authenticated but has no profile created yet.             |
| **userProfile.createProfile**                       | Creates a new user profile with the specified role.                    | `{ role: "student" \| "teacher" }`                           | `Id<"userProfiles">` (The created profile ID)                                                             | Inserts profile record after checking for existing profile and authentication. | Throws error if profile already exists instead of returning existing profile ID.  |
| **userProfile.updateRole**                          | Updates the authenticated user's role.                                 | `{ role: "student" \| "teacher" }`                           | `void` (No return value)                                                                                  | Patches existing profile with new role after authorization check.              | Throws error if profile doesn't exist; doesn't auto-create profile.               |
| **userProfile.setUserRole** [Internal]              | Admin function to set or create a user's role by Better Auth user ID.  | `{ betterAuthUserId: string, role: "student" \| "teacher" }` | `Id<"userProfiles">` (Created or updated profile ID)                                                      | Upserts profile record (creates if missing, updates if exists).                | No validation on betterAuthUserId; can create orphaned profiles if ID is invalid. |
| **userProfile.listAllUsersWithProfiles** [Internal] | Lists all users with their profile information for admin/debugging.    | `{}` (No arguments)                                          | `Array<{ userId: string, email: string, name: string, role: "student" \| "teacher", createdAt: number }>` | Fetches all profiles and enriches with Better Auth user data.                  | No pagination; could be slow with many users.                                     |

---

## Notifications

| Route                                | Normal Behaviour                                                       | API Input Schema                          | API Output Schema                                                                                                                                                     | Implementation                                                           | Undesired Behaviours                                                    |
| ------------------------------------ | ---------------------------------------------------------------------- | ----------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------ | ----------------------------------------------------------------------- |
| **notifications.getMyNotifications** | Retrieves the 50 most recent notifications for the authenticated user. | `{}` (No arguments)                       | `Array<{ _id: Id<"notifications">, userId: string, type: string, title: string, message: string, read: boolean, metadata?: Record<string, any>, createdAt: number }>` | Queries notifications by userId index, ordered desc, limited to 50.      | Hard-coded 50 limit without pagination support for older notifications. |
| **notifications.getUnreadCount**     | Returns count of unread notifications for the authenticated user.      | `{}` (No arguments)                       | `number` (Count of unread notifications)                                                                                                                              | Queries by compound index (userId, read=false) and returns array length. | Returns 0 for unauthenticated users instead of throwing error.          |
| **notifications.markAsRead**         | Marks a specific notification as read.                                 | `{ notificationId: Id<"notifications"> }` | `void` (No return value)                                                                                                                                              | Validates ownership and patches notification with read=true.             | Throws error if notification already read; should be idempotent.        |
| **notifications.markAllAsRead**      | Marks all unread notifications for the user as read.                   | `{}` (No arguments)                       | `void` (No return value)                                                                                                                                              | Queries all unread notifications and patches each in a loop.             | Not atomic; could partially fail leaving some notifications unread.     |
| **notifications.deleteNotification** | Permanently deletes a notification.                                    | `{ notificationId: Id<"notifications"> }` | `void` (No return value)                                                                                                                                              | Validates ownership and deletes notification record.                     | No soft-delete or recovery mechanism once deleted.                      |

---

## Teacher - Classroom Management

| Route                              | Normal Behaviour                                                                                 | API Input Schema                                                                                                    | API Output Schema                                                                                                                                   | Implementation                                                                                     | Undesired Behaviours                                                                |
| ---------------------------------- | ------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------- |
| **teacher.getMyClassrooms**        | Retrieves all classrooms owned by the authenticated teacher.                                     | `{}` (No arguments)                                                                                                 | `Array<{ _id: Id<"classrooms">, className: string, description: string, ownerId: string, createdAt: number, enrollmentRequiresApproval: boolean }>` | Queries classrooms by ownerId index filtered by current user.                                      | Returns empty array for students; no role validation or error thrown.               |
| **teacher.getClassroomDetails**    | Retrieves detailed classroom information including assignments and enrollment counts.            | `{ classroomId: Id<"classrooms"> }`                                                                                 | `{ classroom: {...}, assignments: Array<{...}>, studentCount: number, pendingEnrollments: number }`                                                 | Fetches classroom, assignments, and relations; computes counts from relations array.               | Owner-only access; enrolled students cannot view details despite needing this data. |
| **teacher.getPendingEnrollments**  | Retrieves all pending enrollment requests for a classroom.                                       | `{ classroomId: Id<"classrooms"> }`                                                                                 | `Array<{ _id: Id<"classroomStudentsRelations">, classroomId: Id<"classrooms">, studentId: string, status: "pending", enrolledAt: number }>`         | Queries relations by classroom index and filters for pending status.                               | No student details included; requires separate queries to get student names/emails. |
| **teacher.getEnrolledStudents**    | Retrieves all approved/enrolled students for a classroom.                                        | `{ classroomId: Id<"classrooms"> }`                                                                                 | `Array<{ _id: Id<"classroomStudentsRelations">, classroomId: Id<"classrooms">, studentId: string, status: "approved", enrolledAt: number }>`        | Queries relations by classroom index and filters for approved status.                              | No student details included; requires separate queries for user information.        |
| **teacher.createClassroom**        | Creates a new classroom with the authenticated teacher as owner.                                 | `{ className: string, description: string, enrollmentRequiresApproval: boolean }`                                   | `Id<"classrooms">` (Created classroom ID)                                                                                                           | Validates teacher role from profile and inserts classroom record.                                  | Throws error if user lacks teacher role; no automatic profile creation.             |
| **teacher.updateClassroom**        | Updates classroom details for teacher-owned classrooms.                                          | `{ classroomId: Id<"classrooms">, className?: string, description?: string, enrollmentRequiresApproval?: boolean }` | `void` (No return value)                                                                                                                            | Validates ownership and patches classroom with provided fields.                                    | Optional fields can't be unset/cleared once set.                                    |
| **teacher.deleteClassroom**        | Permanently deletes classroom and all related data (relations, assignments, submissions, flags). | `{ classroomId: Id<"classrooms"> }`                                                                                 | `void` (No return value)                                                                                                                            | Cascades deletes through relations, assignments, submissions, and flags before deleting classroom. | No soft-delete or confirmation; irreversible deletion of all student work.          |
| **teacher.updateEnrollmentStatus** | Approves or rejects a student enrollment request and notifies the student.                       | `{ relationId: Id<"classroomStudentsRelations">, status: "approved" \| "rejected" }`                                | `void` (No return value)                                                                                                                            | Validates ownership, updates relation status, creates notification for student.                    | Rejected enrollments remain in database; no cleanup of rejected relations.          |
| **teacher.removeStudent**          | Removes a student from the classroom by deleting their enrollment relation.                      | `{ relationId: Id<"classroomStudentsRelations"> }`                                                                  | `void` (No return value)                                                                                                                            | Validates ownership and deletes relation record.                                                   | Doesn't delete student's submissions; orphaned data remains in database.            |

---

## Student - Classroom Enrollment

| Route                              | Normal Behaviour                                                                                                          | API Input Schema                    | API Output Schema                                                                                                                                                               | Implementation                                                                                                  | Undesired Behaviours                                                            |
| ---------------------------------- | ------------------------------------------------------------------------------------------------------------------------- | ----------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------- |
| **classroom.getEnrolled**          | Retrieves all classrooms the student is approved to access.                                                               | `{}` (No arguments)                 | `Array<{ _id: Id<"classrooms">, className: string, description: string, ownerId: string, createdAt: number, enrollmentRequiresApproval: boolean }>` (Null entries filtered out) | Queries relations by studentId, filters for approved, fetches classrooms.                                       | Returns empty array for unauthenticated; no error thrown.                       |
| **classroom.getAvailableToEnroll** | Retrieves all classrooms the student can enroll in (not already related).                                                 | `{}` (No arguments)                 | `Array<{ _id: Id<"classrooms">, className: string, description: string, ownerId: string, createdAt: number, enrollmentRequiresApproval: boolean }>`                             | Fetches all classrooms, filters out those with existing relations (any status).                                 | Shows all classrooms including rejected ones; no filtering by rejected status.  |
| **classroom.enroll**               | Enrolls student in classroom (pending or approved based on classroom settings) and notifies teacher if approval required. | `{ classroomId: Id<"classrooms"> }` | `void` (No return value)                                                                                                                                                        | Creates relation with status based on enrollmentRequiresApproval flag; creates teacher notification if pending. | Throws error if already enrolled (any status); can't re-enroll after rejection. |

---

## Teacher - Assignment Management

| Route                                             | Normal Behaviour                                                                        | API Input Schema                                                                                                  | API Output Schema                                                                                                                                                                                                                                             | Implementation                                                                                                             | Undesired Behaviours                                                                                 |
| ------------------------------------------------- | --------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------- |
| **teacherAssignments.getAssignmentsByClassroom**  | Retrieves all assignments for a classroom (accessible by teacher or enrolled students). | `{ classroomId: Id<"classrooms"> }`                                                                               | `Array<{ _id: Id<"assignments">, classroomId: Id<"classrooms">, name: string, description: string, dueDate: string, templateId?: string, createdAt: number }>`                                                                                                | Validates user is owner or approved student, queries assignments by classroom index.                                       | Students with pending enrollment cannot view assignments even if classroom doesn't require approval. |
| **teacherAssignments.createAssignment**           | Creates new assignment and notifies all enrolled students.                              | `{ classroomId: Id<"classrooms">, name: string, description: string, dueDate: string, templateId?: string }`      | `Id<"assignments">` (Created assignment ID)                                                                                                                                                                                                                   | Validates teacher ownership, inserts assignment, creates notifications for all approved students.                          | Creates notification for every student individually; could be slow for large classes.                |
| **teacherAssignments.updateAssignment**           | Updates assignment details for teacher-owned assignments.                               | `{ assignmentId: Id<"assignments">, name?: string, description?: string, dueDate?: string, templateId?: string }` | `void` (No return value)                                                                                                                                                                                                                                      | Validates teacher owns parent classroom, patches assignment with provided fields.                                          | No notifications sent to students about assignment changes.                                          |
| **teacherAssignments.deleteAssignment**           | Permanently deletes assignment and all related data (submissions, flags).               | `{ assignmentId: Id<"assignments"> }`                                                                             | `void` (No return value)                                                                                                                                                                                                                                      | Validates ownership, cascades deletes through flags and submissions, deletes assignment.                                   | No soft-delete; irreversible deletion of all student submission data.                                |
| **teacherAssignments.getSubmissionsByAssignment** | Retrieves all student submissions for an assignment (teacher view).                     | `{ assignmentId: Id<"assignments"> }`                                                                             | `Array<{ _id: Id<"submissions">, assignmentId: Id<"assignments">, studentId: string, submitted: boolean, submittedAt?: number, grade?: number, feedback?: string, gradedAt?: number, gradedBy?: string, workspaceId?: Id<"workspaces">, createdAt: number }>` | Validates teacher owns parent classroom, queries submissions by assignment index.                                          | No student details included; requires separate queries for student names.                            |
| **teacherAssignments.gradeSubmission**            | Grades a student submission and notifies the student.                                   | `{ submissionId: Id<"submissions">, grade: number, feedback?: string }`                                           | `void` (No return value)                                                                                                                                                                                                                                      | Validates teacher ownership through classroom chain, patches submission with grade/feedback, creates student notification. | Can overwrite existing grades without warning; no grade history tracking.                            |
| **teacherAssignments.createFlag**                 | Creates a flag for suspicious work on a submission.                                     | `{ submissionId: Id<"submissions">, type: string, description: string }`                                          | `Id<"flags">` (Created flag ID)                                                                                                                                                                                                                               | Validates teacher ownership through classroom chain, inserts flag record.                                                  | No notification to student; type is free-form string without validation.                             |
| **teacherAssignments.getFlagsBySubmission**       | Retrieves all flags for a submission (teacher only).                                    | `{ submissionId: Id<"submissions"> }`                                                                             | `Array<{ _id: Id<"flags">, submissionId: Id<"submissions">, type: string, description: string, timestamp: number, flaggedBy: string }>`                                                                                                                       | Validates teacher ownership through classroom chain, queries flags by submission index.                                    | Student cannot see flags on their own work; no transparency for flagged submissions.                 |
| **teacherAssignments.deleteFlag**                 | Permanently deletes a flag from a submission.                                           | `{ flagId: Id<"flags"> }`                                                                                         | `void` (No return value)                                                                                                                                                                                                                                      | Validates teacher ownership through full chain (flag→submission→assignment→classroom), deletes flag.                       | No audit trail of deleted flags; no soft-delete mechanism.                                           |

---

## Student - Submission Management

| Route                                        | Normal Behaviour                                                                    | API Input Schema                                                      | API Output Schema                                                                                                                                                                                                                                              | Implementation                                                                          | Undesired Behaviours                                                                     |
| -------------------------------------------- | ----------------------------------------------------------------------------------- | --------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------- |
| **submissions.getOrCreateSubmission**        | Gets existing submission or creates a new unsubmitted submission for an assignment. | `{ assignmentId: Id<"assignments"> }`                                 | `Id<"submissions">` (Existing or created submission ID)                                                                                                                                                                                                        | Queries by compound index (assignmentId, studentId), creates if missing.                | Creates submission even if student not enrolled in classroom; no authorization check.    |
| **submissions.submitAssignment**             | Marks assignment as submitted with optional workspace reference.                    | `{ assignmentId: Id<"assignments">, workspaceId?: Id<"workspaces"> }` | `Id<"submissions">` (Submission ID)                                                                                                                                                                                                                            | Gets or creates submission, updates with submitted=true and timestamp.                  | No validation if student is enrolled or assignment exists; can submit to any assignment. |
| **submissions.unsubmitAssignment**           | Unsubmits an assignment (removes submission status) if not yet graded.              | `{ assignmentId: Id<"assignments"> }`                                 | `void` (No return value)                                                                                                                                                                                                                                       | Finds submission, validates not graded, patches to remove submitted flag and timestamp. | Uses grade presence check instead of explicit graded flag; could break with 0 grades.    |
| **submissions.getMySubmissions**             | Retrieves all submissions for the authenticated student.                            | `{}` (No arguments)                                                   | `Array<{ _id: Id<"submissions">, assignmentId: Id<"assignments">, studentId: string, submitted: boolean, submittedAt?: number, grade?: number, feedback?: string, gradedAt?: number, gradedBy?: string, workspaceId?: Id<"workspaces">, createdAt: number }>`  | Queries submissions by studentId index for current user.                                | Returns empty array for unauthenticated; no error thrown.                                |
| **submissions.getMySubmissionForAssignment** | Retrieves student's submission for a specific assignment.                           | `{ assignmentId: Id<"assignments"> }`                                 | `{ _id: Id<"submissions">, assignmentId: Id<"assignments">, studentId: string, submitted: boolean, submittedAt?: number, grade?: number, feedback?: string, gradedAt?: number, gradedBy?: string, workspaceId?: Id<"workspaces">, createdAt: number } \| null` | Queries by compound index (assignmentId, studentId) for current user.                   | Returns null for unauthenticated instead of throwing error.                              |

---

## Assignment & Workspace Management

| Route                                            | Normal Behaviour                                                                         | API Input Schema                                                                 | API Output Schema                                                                                                                                                                      | Implementation                                                                                                              | Undesired Behaviours                                                                 |
| ------------------------------------------------ | ---------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------ |
| **assignment.getById**                           | Retrieves a single assignment by ID.                                                     | `{ id: Id<"assignments"> }`                                                      | `{ _id: Id<"assignments">, classroomId: Id<"classrooms">, name: string, description: string, dueDate: string, templateId?: string, createdAt: number } \| null`                        | Simple database get after authentication check.                                                                             | No authorization check; any authenticated user can view any assignment.              |
| **assignment.getByIds**                          | Retrieves multiple assignments by their IDs.                                             | `{ ids: Array<Id<"assignments">> }`                                              | `Array<{ _id: Id<"assignments">, classroomId: Id<"classrooms">, name: string, description: string, dueDate: string, templateId?: string, createdAt: number }>` (Null entries filtered) | Parallel fetches all IDs and filters nulls.                                                                                 | No authorization check; any authenticated user can batch-query any assignments.      |
| **assignment.launchWorkspace**                   | Launches or resumes a Coder workspace for the assignment, creating Coder user if needed. | `{ assignmentId: Id<"assignments"> }`                                            | `{ workspaceUrl: string, coderUserSessionKey: string }`                                                                                                                                | Creates/fetches Coder user, gets/creates workspace, stops other workspaces, generates session key, stores active workspace. | Stops ALL other workspaces for user; could disrupt work on other assignments.        |
| **assignment.setUserActiveWorkspace** [Internal] | Sets the user's active workspace, deleting previous active workspace records.            | `{ userId: string, coderWorkspaceId: string, assignmentId?: Id<"assignments"> }` | `void` (No return value)                                                                                                                                                               | Deletes all existing workspace records for user except current one, inserts new record.                                     | Not atomic; could leave user with no active workspace if insert fails after deletes. |
| **assignment.getUserActiveWorkspace** [Internal] | Retrieves the user's current active workspace.                                           | `{ userId: string }`                                                             | `{ _id: Id<"workspaces">, userId: string, coderWorkspaceId: string, assignmentId?: Id<"assignments">, createdAt: number } \| null`                                                     | Simple query filter by userId returning first match.                                                                        | Returns first if multiple exist (shouldn't happen but not prevented).                |

---

## Event Tracking

| Route                                   | Normal Behaviour                                                             | API Input Schema                                                                              | API Output Schema                                               | Implementation                                                                     | Undesired Behaviours                                                                                     |
| --------------------------------------- | ---------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------- | --------------------------------------------------------------- | ---------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| **extension.addBatchedChangesMutation** | Batch inserts events from VS Code extension for workspace activity tracking. | `{ changes: Array<{ eventType: string, timestamp: number, metadata: Record<string, any> }> }` | `void` (No return value, insertedIds computed but not returned) | Loops through changes and inserts each as event record with hardcoded workspaceId. | Authentication commented out; anyone can insert events; hardcoded workspaceId instead of dynamic lookup. |

---

## Analytics/Replay

| Route                 | Normal Behaviour                                                  | API Input Schema    | API Output Schema                                                                                          | Implementation                                                          | Undesired Behaviours                                                                                      |
| --------------------- | ----------------------------------------------------------------- | ------------------- | ---------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------- |
| **replay.getReplays** | Retrieves all events grouped by workspace ID for replay/analysis. | `{}` (No arguments) | `Record<Id<"workspaces">, Array<Record<string, any>>>` (Events bucketed by workspace, sorted by timestamp) | Fetches all events, groups by workspaceId, sorts metadata by timestamp. | Authentication commented out; no filtering by user; returns ALL events for ALL workspaces; no pagination. |

---

## Internal/Admin

| Route                                 | Normal Behaviour                                                                             | API Input Schema    | API Output Schema                 | Implementation                                                                                                       | Undesired Behaviours                                                                                     |
| ------------------------------------- | -------------------------------------------------------------------------------------------- | ------------------- | --------------------------------- | -------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| **clearData.clearAllData** [Internal] | Deletes all data from all tables in the database.                                            | `{}` (No arguments) | `void` (Logs progress to console) | Collects all records from each table and deletes in dependency order.                                                | No confirmation; no backup; irreversible destruction of all data.                                        |
| **index.createMock** [Internal]       | Creates mock McMaster CS course data with classrooms, assignments, enrollments, submissions. | `{}` (No arguments) | `void` (Logs progress to console) | Inserts realistic mock data for 7 classrooms, 25+ assignments, 10 students, enrollments, submissions, notifications. | Throws error if data already exists; uses fake user IDs that don't correspond to real Better Auth users. |

---

## Summary Statistics

- **Total Endpoints:** 49
- **Public Queries:** 18
- **Public Mutations:** 24
- **Actions:** 1
- **Internal Functions:** 6

### By Domain:

- Authentication: 1
- User Profiles: 5
- Classrooms (Teacher): 9
- Classrooms (Student): 3
- Assignments (Teacher): 9
- Assignments (Student): 5
- Submissions (Student): 5
- Workspace Management: 5
- Notifications: 5
- Event Tracking: 1
- Analytics/Replay: 1
- Internal/Admin: 2

---

_Generated: 2026-01-22_
