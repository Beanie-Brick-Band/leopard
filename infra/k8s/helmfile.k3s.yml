# helmfile.k3s.yml
# Helmfile for deploying Coder on k3s (uses built-in Traefik)

repositories:
  - name: jetstack
    url: https://charts.jetstack.io

  - name: bitnami
    url: https://charts.bitnami.com/bitnami

  - name: coder-v2
    url: https://helm.coder.com/v2

  - name: minio
    url: https://charts.min.io/

releases:
  # --- Cert Manager ---
  - name: cert-manager
    namespace: cert-manager
    createNamespace: true
    chart: jetstack/cert-manager
    version: v1.17.2
    set:
      - name: crds.enabled
        value: true

  # --- PostgreSQL ---
  - name: postgresql
    namespace: coder
    createNamespace: true
    chart: bitnami/postgresql
    version: 18.1.8
    values:
      - auth:
          username: coder
          password: coderpassword
          database: coder

  # --- Coder Core ---
  - name: coder
    namespace: coder
    chart: coder-v2/coder
    version: 2.28.0
    needs:
      - coder/postgresql
    values:
      - ./values.k3s.yml

  # --- MinIO (S3-compatible object storage) ---
  - name: minio
    namespace: minio
    createNamespace: true
    chart: minio/minio
    version: 5.4.0
    values:
      - ./minio-values.yml
